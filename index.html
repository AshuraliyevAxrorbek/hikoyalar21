<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>Hikoyalar21 ‚Äî Romantic Sensual</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-deep: #07020a;
    --aurora-1: rgba(255,182,193,0.14); /* rose */
    --aurora-2: rgba(224,182,255,0.12); /* soft violet */
    --rose: #ff7aa2;
    --gold: #d7a86e;
    --muted: rgba(255,255,255,0.78);
    --glass-opa: 0.12;
    --glass-border: rgba(255,255,255,0.06);
    --card-radius: 18px;
    --dock-radius: 30px;
    --soft-shadow: 0 14px 50px rgba(3,0,10,0.6);
    --anim-speed: 0.32s;
    --max-width: 720px;
  }

  [data-theme="light"]{
    --bg-deep: linear-gradient(180deg,#fff7f4,#fff8f6);
    --muted: #4a2a25;
  }

  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;outline:none}
  html,body{height:100%}
  body{
    font-family: "Source Sans Pro", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(255,122,162,0.05), transparent 10%),
                radial-gradient(1000px 500px at 90% 90%, rgba(215,168,110,0.03), transparent 10%),
                var(--bg-deep);
    color: #fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow:hidden;
    position:relative;
  }

  /* Aurora / liquid background */
  .aurora {
    position:fixed; inset:-120px; z-index:-3; pointer-events:none; overflow:hidden;
  }
  .aurora .blob {
    position:absolute; border-radius:50%; filter: blur(110px); opacity:0.6; mix-blend-mode:screen;
    animation: drift 28s infinite alternate ease-in-out;
  }
  .b1{ width:780px;height:780px; background: radial-gradient(circle at 30% 30%, var(--aurora-1), transparent 40%); top:-18%; left:-8%;}
  .b2{ width:680px;height:680px; background: radial-gradient(circle at 70% 70%, var(--aurora-2), transparent 40%); bottom:-18%; right:-6%; animation-duration:34s;}
  .b3{ width:420px;height:420px; background: radial-gradient(circle at 50% 50%, rgba(255,200,210,0.28), transparent 50%); top:48%; left:56%; opacity:0.55; animation-duration:30s;}

  @keyframes drift {
    0%{ transform: translate(0,0) scale(1) rotate(0deg); }
    50%{ transform: translate(60px,-40px) scale(1.03) rotate(6deg); }
    100%{ transform: translate(-30px,40px) scale(.98) rotate(-5deg); }
  }

  /* Glass utility */
  .glass {
    background: linear-gradient(180deg, rgba(255,255,255,var(--glass-opa)), rgba(255,255,255,calc(var(--glass-opa)-0.02)));
    border:1px solid var(--glass-border);
    backdrop-filter: blur(14px) saturate(120%);
    -webkit-backdrop-filter: blur(14px) saturate(120%);
    box-shadow: var(--soft-shadow);
    border-radius:var(--card-radius);
    transition: all var(--anim-speed) ease;
  }

  .app {
    max-width: var(--max-width); margin:0 auto; height:100vh; position:relative; display:flex; flex-direction:column;
  }

  /* Views */
  .view { position:absolute; inset:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-bottom:160px; z-index:1; opacity:0; pointer-events:none; transition:opacity var(--anim-speed) ease; }
  .view.active{ opacity:1; pointer-events:auto; z-index:2; }

  /* Header */
  header {
    position:sticky; top:14px; margin:14px 16px 6px 16px; z-index:40;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:12px; border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.05);
    box-shadow: 0 10px 30px rgba(3,0,10,0.5);
    backdrop-filter: blur(16px) saturate(120%);
  }

  .brand { display:flex; align-items:center; gap:12px }
  .logo {
    width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(135deg, var(--rose), var(--gold));
    font-size:20px; box-shadow: 0 8px 28px rgba(215,168,110,0.12);
  }
  .brand .title { font-family:'Playfair Display', serif; font-weight:700; font-size:18px; line-height:1; color:linear-gradient; }
  .brand .subtitle { font-size:12px; color:var(--muted); margin-top:2px; }

  .header-actions { display:flex; gap:10px; align-items:center }

  /* Search */
  .search-wrap { padding:12px 18px 0; margin-top:6px; }
  .search {
    width:calc(100% - 36px); margin:0 auto; display:block;
    height:54px; border-radius:14px; padding:0 18px 0 52px; font-size:15px; color:#fff;
    border:1px solid rgba(255,255,255,0.04);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: inset 0 6px 18px rgba(3,0,10,0.45);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ffb1c7' d='M10.5 3A6.5 6.5 0 0 1 17 9.5c0 1.61-.59 3.09-1.56 4.23l.25.25h.79l5 5-1.5 1.5-5-5v-.79a6.5 6.5 0 0 1-4.23 1.56A6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 10.5 3m0 2A4.5 4.5 0 0 0 6 9.5 4.5 4.5 0 0 0 10.5 14 4.5 4.5 0 0 0 15 9.5 4.5 4.5 0 0 0 10.5 5z'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:16px center; background-size:18px 18px;
    transition: transform .18s, box-shadow .18s;
  }
  .search:focus { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(255,122,162,0.06); outline:none }

  /* Categories */
  .cats { display:flex; gap:10px; padding:12px 18px; overflow-x:auto; scrollbar-width:none; }
  .cats::-webkit-scrollbar{ display:none; }
  .chip { padding:8px 14px; border-radius:999px; font-weight:600; font-size:13px; white-space:nowrap;
         color:var(--muted); border:1px solid rgba(255,255,255,0.03); background:transparent; transition: transform .14s, background .18s; }
  .chip.active { background: linear-gradient(90deg, rgba(255,122,162,0.12), rgba(215,168,110,0.08)); color:#fff; transform:translateY(-4px); box-shadow: 0 8px 30px rgba(215,168,110,0.08); }

  /* Feed */
  .feed { padding:6px 16px 160px; display:flex; flex-direction:column; gap:14px; }
  .story { padding:14px; border-radius:14px; cursor:pointer; transition: transform .12s, box-shadow .18s; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); }
  .story:hover { transform: translateY(-6px); box-shadow: 0 18px 50px rgba(3,0,10,0.48); }
  .meta { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
  .tag { font-size:12px; font-weight:700; color:var(--gold) }
  .views { font-size:13px; color:var(--muted) }

  .title { font-family:'Playfair Display', serif; font-size:18px; margin-bottom:6px; color:#fff }
  .excerpt { font-size:14px; color:var(--muted); line-height:1.45; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .author-row { display:flex; justify-content:space-between; margin-top:10px; color:var(--muted); font-size:13px }

  /* Reader (fullscreen modal-like) */
  .reader-overlay {
    position:fixed; inset:0; z-index:120; display:flex; align-items:center; justify-content:center; padding:18px;
    background: linear-gradient(180deg, rgba(5,2,6,0.76), rgba(5,2,6,0.82));
    backdrop-filter: blur(10px);
    opacity:0; pointer-events:none; transition: opacity .28s ease;
  }
  .reader-overlay.show { opacity:1; pointer-events:auto; }

  .reader-card {
    width:100%; max-width:820px; max-height:92vh; overflow:auto; border-radius:20px; padding:26px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    box-shadow: 0 30px 80px rgba(3,0,10,0.7);
    transform-origin:center; animation: popIn .28s ease;
  }
  @keyframes popIn { from { transform: translateY(8px) scale(.995); opacity:0 } to { transform: translateY(0) scale(1); opacity:1 } }

  .reader-head { display:flex; justify-content:space-between; align-items:center; gap:12px }
  .reader-title {
    font-family: 'Playfair Display', serif; font-size:36px; text-align:center; color:var(--rose);
    letter-spacing:-0.02em; margin:18px 0 8px;
  }
  .reader-sub { text-align:center; color:var(--muted); margin-bottom:18px; font-size:14px }

  /* Paragraphs ‚Äî serif with drop cap for first paragraph */
  .reader-body { font-family:'Playfair Display', serif; font-size:18px; color:var(--muted); line-height:1.9; padding:6px 6px 36px; }
  .reader-body p { margin-bottom:16px; text-indent:1.2em; }
  .reader-body p:first-of-type { font-size:20px; font-family:'Playfair Display', serif; line-height:1.6; color:#fff; opacity:0.98; }
  .reader-body p:first-of-type::first-letter {
    float:left; font-size:56px; line-height:0.75; margin-right:12px; font-weight:900; color:var(--gold);
    font-family: 'Playfair Display', serif;
  }

  .reader-meta { display:flex; justify-content:center; gap:14px; color:var(--muted); margin-top:8px; font-size:13px }

  .reader-actions { display:flex; gap:12px; justify-content:center; margin-top:16px; }
  .action-btn { padding:10px 16px; border-radius:12px; display:flex; gap:8px; align-items:center; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); cursor:pointer; }

  /* Profile */
  .profile { padding: 10px 16px 80px; }
  .profile-header { text-align:center; padding:18px 10px; }
  .avatar { width:84px;height:84px;border-radius:20px;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--rose),var(--gold));font-size:32px;margin-bottom:10px;box-shadow:0 8px 30px rgba(215,168,110,0.12) }
  .profile-name { font-family:'Playfair Display', serif; font-weight:700; font-size:18px }
  .profile-sub { color:var(--muted); font-size:13px; margin-top:6px }

  /* Dock */
  .dock-wrap {
    position:fixed; left:50%; transform:translateX(-50%); bottom: calc(14px + env(safe-area-inset-bottom)); z-index:60;
    width: calc(100% - 36px); max-width:760px; height:86px; border-radius:var(--dock-radius); padding:10px;
    display:flex; align-items:center; justify-content:space-around; gap:8px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.06); backdrop-filter: blur(18px) saturate(120%);
    box-shadow: 0 18px 60px rgba(3,0,10,0.6);
  }
  .dock-btn { flex:1; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; border-radius:14px; cursor:pointer; color:var(--muted); font-size:13px; transition: transform .16s, background .16s; padding:8px 10px }
  .dock-btn .ico { font-size:22px }
  .dock-btn.active { transform: translateY(-6px); color:var(--rose); background: linear-gradient(90deg, rgba(255,122,162,0.08), rgba(215,168,110,0.06)); box-shadow: 0 10px 34px rgba(215,168,110,0.08); border-radius:12px }

  /* Toast */
  .toast { position: fixed; left:50%; transform:translateX(-50%) translateY(-120px); top:20px; z-index:120; background: rgba(0,0,0,0.55); color:#fff; padding:10px 18px; border-radius:999px; backdrop-filter: blur(6px); transition: transform .36s cubic-bezier(.2,.9,.2,1), opacity .28s }
  .toast.show { transform:translateX(-50%) translateY(8px) }

  /* Responsive tweaks */
  @media (max-width:420px){
    .reader-title{ font-size:26px }
    .reader-body p:first-of-type::first-letter { font-size:44px; }
    .dock-wrap{ height:78px }
  }
</style>
</head>
<body data-theme="dark">
  <div class="aurora" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <div class="app" role="application" aria-label="Hikoyalar21 - Romantic Sensual">
    <div id="toast" class="toast" aria-live="polite" style="opacity:0;">Xabar</div>

    <!-- HOME VIEW -->
    <main id="home" class="view active" aria-label="Bosh sahifa">
      <header class="glass" role="banner" aria-label="Header">
        <div class="brand">
          <div class="logo">üíò</div>
          <div>
            <div class="title" style="color:#fff; font-family:'Playfair Display', serif">Hikoyalar21</div>
            <div class="subtitle">EHTIROSLI & ROMANTIK</div>
          </div>
        </div>
        <div class="header-actions">
          <div class="action-icon" role="button" title="Profilga o'tish" onclick="switchView('profile')">üë§</div>
        </div>
      </header>

      <div class="search-wrap">
        <input id="searchField" class="search" type="search" placeholder="Hikoya, hissiyot yoki muallif..." aria-label="Qidiruv">
      </div>

      <div class="cats" role="tablist" aria-label="Toifalar">
        <button class="chip active" data-cat="all">üî• Hammasi</button>
        <button class="chip" data-cat="romantik">‚ù§Ô∏è Romantik</button>
        <button class="chip" data-cat="ehtiros">üíã Ehtiros</button>
        <button class="chip" data-cat="sirli">üîÆ Sirli</button>
        <button class="chip" data-cat="drama">ü•Ä Drama</button>
      </div>

      <section id="feed" class="feed" aria-live="polite"></section>
    </main>

    <!-- PROFILE VIEW -->
    <section id="profile" class="view" aria-label="Profil">
      <header class="glass">
        <div style="display:flex;align-items:center;gap:10px;">
          <div role="button" onclick="switchView('home')" title="Ortga">‚¨ÖÔ∏è</div>
          <div style="font-family:'Playfair Display', serif; font-weight:700;">Mening Profilim</div>
        </div>
        <div style="width:26px;"></div>
      </header>

      <div class="profile">
        <div class="profile-header">
          <div class="avatar">üíñ</div>
          <div class="profile-name">Maxfiy O'quvchi</div>
          <div class="profile-sub">Hikoyalar21 A'zosi</div>
        </div>

        <div style="padding: 0 18px;">
          <a class="glass" href="https://t.me/hikoyalar21_bot" target="_blank" style="display:block;text-align:center;padding:12px;border-radius:12px;text-decoration:none;color:white;background:linear-gradient(90deg,var(--rose),var(--gold));font-weight:700;">ü§ñ Botga o'tish</a>
        </div>

        <div style="margin-top:16px;padding:0 18px;">
          <div class="glass" style="padding:12px;display:flex;justify-content:space-between;align-items:center;border-radius:12px;">
            <div>üåó Tun/Kun Rejimi</div>
            <div id="themeToggle" role="button" style="cursor:pointer;">üåô</div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin:14px 18px;">
          <button class="glass" id="tabSaved" onclick="renderProfileList('saved')" style="flex:1;padding:10px;border-radius:12px;">üíæ Saqlanganlar</button>
          <button class="glass" id="tabLiked" onclick="renderProfileList('liked')" style="flex:1;padding:10px;border-radius:12px;">‚ù§Ô∏è Yoqqanlar</button>
        </div>

        <div id="profileFeed" style="padding: 0 16px 40px;"></div>
      </div>
    </section>

    <!-- Reader overlay (full-screen when open) -->
    <div id="readerOverlay" class="reader-overlay" aria-hidden="true" role="dialog" aria-modal="true">
      <article class="reader-card glass" role="document" aria-label="Hikoya mutolaa">
        <div class="reader-head">
          <div role="button" onclick="closeReader()" title="Yopish">‚¨áÔ∏è</div>
          <div style="font-family:'Playfair Display', serif; font-weight:700; color:#fff">Mutolaa</div>
          <div id="ttsBtn" role="button" title="Matnni o'qish">üîä</div>
        </div>

        <div id="readerInner" style="margin-top:6px;">
          <div id="rTitle" class="reader-title">Hikoya nomi</div>
          <div id="rSub" class="reader-sub">Muallif ¬∑ Toifa ¬∑ Ko‚Äòrishlar</div>

          <div id="rBody" class="reader-body">
            <!-- Filled by JS -->
          </div>

          <div class="reader-meta" id="rMeta"></div>

          <div class="reader-actions" style="margin-top:18px;">
            <div class="action-btn" id="likeBtn"><span id="likeIcon">ü§ç</span><span style="font-weight:600;">Yoqdi</span></div>
            <div class="action-btn" id="saveBtn"><span id="saveIcon">üì•</span><span style="font-weight:600;">Saqlash</span></div>
            <div class="action-btn" onclick="shareCurrent()"><span>üîó</span><span style="font-weight:600;">Ulashish</span></div>
          </div>
        </div>
      </article>
    </div>

    <!-- Dock -->
    <nav class="dock-wrap glass" role="navigation" aria-label="Asosiy panel">
      <div class="dock-btn active" id="dockHome" onclick="switchView('home')"><span class="ico">üè†</span><span class="label">Uy</span></div>
      <div class="dock-btn" id="dockRand" onclick="randomStory()"><span class="ico">üé≤</span><span class="label">Tasodif</span></div>
      <div class="dock-btn" id="dockSaved" onclick="switchView('profile'); renderProfileList('saved')"><span class="ico">üíæ</span><span class="label">Saq.</span></div>
      <div class="dock-btn" id="dockLiked" onclick="switchView('profile'); renderProfileList('liked')"><span class="ico">‚ù§Ô∏è</span><span class="label">Yoq.</span></div>
    </nav>
  </div>

<script>
/* =======================
   DATA
   ======================= */
const stories = [
  { id: 1, title: "Yomg'ir Ostidagi Titroq Bo'sa", author: "Aziza N.", cat: "romantik", views: 1204, likes: 45, excerpt: "Kech kuz. Yomg'ir shivalab yog'ardi. U deraza yonida o'tirib...", text: "<p>Kech kuz. Yomg'ir shivalab yog'ardi. U deraza yonida o'tirib, ko'chada shoshilib ketayotgan odamlarni kuzatardi. To'satdan telefon jiringladi. Bu u edi. Uning ovozi xuddi kutilmagan baxt kabi eshitildi.</p><p>Uchrashuv joyi o'sha eski xiyobon. U soyabonini oldi-yu, yuragi dukullab uchrashuvga oshiqdi. Ular ko'rishganda so'zlar kerak emasdi. Nigohlar to'qnashdi. Yomg'ir tomchilari ularning yuzini yuvardi, ammo ular sovuqni his qilishmasdi. Uning issiq kaftlari qizning yuzini tutdi.</p><p>Sekin yaqinlashdi. Bu dunyodagi eng mayin va <em>ehtirosli bo'sa</em> edi. Go'yo vaqt to'xtab qolgandek, atrofda faqat yomg'ir ovozi va ularning yurak urishi eshitilardi. Bu lahza abadiyatga teng edi.</p>" },
  { id: 2, title: "Tungi Mehmon: Maxfiy Visol", author: "Rustam K.", cat: "ehtiros", views: 2500, likes: 88, excerpt: "Soat tungi ikkiga yaqinlashgandi. Eshik qo'ng'irog'i chalindi...", text: "<p>Soat tungi ikkiga yaqinlashgandi. Eshik qo'ng'irog'i chalindi. U kimligini bilar edi. Eshikni ochishi bilan xonaga tanish atir hidi va tunning salqini kirib keldi. Hech qanday salom-alik bo'lmadi. Faqat sog'inch to'la quchoq va lablarning titroq pichirlashi. 'Men seni sog'indim', dedi u bo'g'iq ovozda.</p><p>Chiroqlar o'chirildi, faqat ko'cha chirog'ining xira nuri xonani yoritardi. Har bir teginish <em>elektr toki kabi</em> butun tanani junbushga keltirardi. Bu tun ular uchun abadiydek tuyulardi. Ehtiros olovi ikkisini ham kul qilgudek yonardi...</p><p>Tong otishini hech kim kutmasdi. Faqat birga bo'lish zavqi bor edi. Bu tun ularning maxfiy sirlari bilan to'la edi.</p>" },
  { id: 3, title: "Ofisdagi Sir: Taqiqlangan Ishq", author: "Malika", cat: "ehtiros", views: 1800, likes: 62, excerpt: "Hamma ketgandi. Faqat men va boshliq qolgandik...", text: "<p>Barcha xodimlar uyga ketgandi. Faqat men va boshliq qolgandik. Loyihani tugatish kerak edi, lekin ikkimizning ham hayolimiz ishda emasdi. U mening stolim yoniga keldi.</p><p>'Charchadingizmi?' deb so'radi u past ovozda. Uning nigohida g'alati bir uchqun bor edi. Men boshimni ko'tarib, uning ko'zlariga qaradim. O'rtadagi masofa tobora qisqarib borardi. Na fasllar, na dunyo, na ish qoldi. Faqat ikkimiz va taqiqlangan hissiyotlar.</p><p>Uning qo'li yelkamga tegishi bilan barcha chegaralar buzildi. Bu ofis endi ish joyi emas, balki bizning maxfiy sevgimiz uyiga aylangandi. Bu sirlarni faqat tun bilardi.</p>" },
  { id: 4, title: "Yashirin Maktubdagi Drama", author: "Nomsiz", cat: "drama", views: 800, likes: 25, excerpt: "Eski kitob ichidan sarg'aygan qog'oz tushib ketdi. U qo'llari qaltirab maktubni ochdi...", text: "<p>Eski kitob ichidan sarg'aygan qog'oz tushib ketdi. U qo'llari qaltirab maktubni ochdi. Bu yozuv unga juda tanish edi. 'Azizim, agar sen buni o'qiyotgan bo'lsang, demak men endi yoningda emasman...' Ko'z yoshlari maktubga tomchilardi. O'tmishning shirin va azobli xotiralari uni o'z domiga tortdi.</p><p>U bu haqiqatni qabul qila olmasdi. Afsus, u endi yo'q edi. Ammo uning sevgisi maktubda abadiy qolgandi.</p>" },
  { id: 5, title: "Qasr Arvohi va Ishq", author: "Mirsodiq", cat: "sirli", views: 950, likes: 30, excerpt: "Qadimgi qasrda tunashga to'g'ri keldi. Derazadan oy nuri tushardi...", text: "<p>Qadimgi qasrda tunashga to'g'ri keldi. Derazadan oy nuri tushardi. Xona sovuq, lekin ichimda g'alati olov yonardi. To'satdan ko'zgu ortidan sharpa o'tdi.</p><p>Bu arzand arvoh edi. U yillar davomida sevgisini kutgan. Endi men uning o'rnida edim. Sovuq qo'l yuzimga tegdi... Bu qo'rquv emas, balki <em>ajoyib visol</em> edi. Jismoniy chegaralar yo'qolgan sevgi.</p>" }
];

/* =======================
   STATE & DOM
   ======================= */
let state = {
  saved: JSON.parse(localStorage.getItem('h21_saved') || '[]'),
  liked: JSON.parse(localStorage.getItem('h21_liked') || '[]'),
  theme: localStorage.getItem('h21_theme') || 'dark',
  current: null
};

const feedEl = document.getElementById('feed');
const searchEl = document.getElementById('searchField');
const chips = Array.from(document.querySelectorAll('.chip'));
const toastEl = document.getElementById('toast');
const profileFeedEl = document.getElementById('profileFeed');
const readerOverlay = document.getElementById('readerOverlay');
const rTitle = document.getElementById('rTitle');
const rSub = document.getElementById('rSub');
const rBody = document.getElementById('rBody');
const rMeta = document.getElementById('rMeta');
const likeBtn = document.getElementById('likeBtn');
const saveBtn = document.getElementById('saveBtn');
const ttsBtn = document.getElementById('ttsBtn');
const themeToggle = document.getElementById('themeToggle');

/* init theme */
document.body.setAttribute('data-theme', state.theme);
updateThemeIcon();

/* RENDER HOME */
function renderHome(filter='all', q=''){
  feedEl.innerHTML = '';
  const query = (q || '').toLowerCase().trim();
  const list = stories.filter(s=>{
    const catMatch = filter === 'all' || s.cat === filter;
    const text = (s.title + ' ' + s.author + ' ' + s.excerpt).toLowerCase();
    const searchMatch = !query || text.includes(query);
    return catMatch && searchMatch;
  });

  if(list.length===0){ feedEl.innerHTML = `<div style="text-align:center;padding:36px;color:var(--muted)">Hikoyalar topilmadi ü•Ä</div>`; return; }

  list.forEach(s=>{
    const isSaved = state.saved.includes(s.id);
    const node = document.createElement('article');
    node.className = 'story glass';
    node.tabIndex = 0;
    node.innerHTML = `
      <div class="meta">
        <div class="tag">#${s.cat.toUpperCase()}</div>
        <div class="views">üëÅÔ∏è ${s.views}</div>
      </div>
      <div class="title">${s.title} ${isSaved? 'üíæ':''}</div>
      <div class="excerpt">${s.excerpt}</div>
      <div class="author-row">
        <div>üë§ ${s.author}</div>
        <div>‚ù§Ô∏è ${s.likes}</div>
      </div>
    `;
    node.addEventListener('click', ()=> openReader(s.id));
    node.addEventListener('keydown', (e)=> { if(e.key==='Enter') openReader(s.id); });
    feedEl.appendChild(node);
  });
}

/* OPEN / CLOSE READER */
function openReader(id){
  const s = stories.find(x => x.id === id);
  if(!s) return;
  state.current = s;
  rTitle.textContent = s.title;
  rSub.textContent = `${s.author} ¬∑ #${s.cat} ¬∑ üëÅÔ∏è ${s.views}`;
  rBody.innerHTML = s.text;
  rMeta.innerHTML = `‚ù§Ô∏è ${s.likes} ¬∑ Saqlangan: ${state.saved.includes(id) ? 'Ha' : 'Yo\'q'}`;
  updateReaderButtons();
  readerOverlay.classList.add('show');
  readerOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  // animate first paragraph fade-in
  const p = rBody.querySelector('p:first-of-type');
  if(p){
    p.style.opacity = '0'; p.style.transform = 'translateY(6px)';
    setTimeout(()=>{ p.style.transition='opacity .6s ease, transform .6s ease'; p.style.opacity='1'; p.style.transform='translateY(0)'; }, 80);
  }
}
function closeReader(){
  readerOverlay.classList.remove('show');
  readerOverlay.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  window.speechSynthesis.cancel();
}

/* update reader buttons */
function updateReaderButtons(){
  if(!state.current) return;
  const liked = state.liked.includes(state.current.id);
  const saved = state.saved.includes(state.current.id);
  likeBtn.querySelector('span').innerText = liked ? '‚ù§Ô∏è' : 'ü§ç';
  saveBtn.querySelector('span').innerText = saved ? 'üíæ' : 'üì•';
  likeBtn.style.color = liked ? 'var(--rose)' : '';
  saveBtn.style.color = saved ? 'var(--rose)' : '';
}

/* like & save handlers */
likeBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(!state.current) return showToast("Hikoya tanlanmagan");
  const id = state.current.id;
  if(state.liked.includes(id)){
    state.liked = state.liked.filter(x=> x!==id);
    showToast("Like olib tashlandi üíî");
  } else {
    state.liked.push(id);
    state.current.likes++;
    showToast("Sizga yoqdi! ‚ù§Ô∏è");
  }
  localStorage.setItem('h21_liked', JSON.stringify(state.liked));
  updateReaderButtons();
});

saveBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(!state.current) return showToast("Hikoya tanlanmagan");
  const id = state.current.id;
  if(state.saved.includes(id)){
    state.saved = state.saved.filter(x=> x!==id);
    showToast("Saqlanganlardan o'chirildi");
  } else {
    state.saved.push(id);
    showToast("Saqlandi üíæ");
  }
  localStorage.setItem('h21_saved', JSON.stringify(state.saved));
  updateReaderButtons();
  renderHome(document.querySelector('.chip.active').dataset.cat, searchEl.value);
});

/* share */
function shareCurrent(){
  if(!state.current) return showToast("Hikoya tanlanmagan");
  const text = `Men "${state.current.title}" hikoyasini o'qidim! Siz ham o'qing: Hikoyalar21`;
  if(navigator.share){
    navigator.share({title: state.current.title, text, url: location.href}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(text).then(()=> showToast("Havola nusxalandi üîó"));
  }
}

/* tts */
ttsBtn.addEventListener('click', ()=>{
  if(!state.current) return showToast("Hikoya tanlanmagan");
  if(window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); showToast("O'qish to'xtatildi üõë"); return; }
  const clean = state.current.text.replace(/<[^>]*>/g,' ');
  const ut = new SpeechSynthesisUtterance(clean);
  ut.lang = 'uz-UZ';
  window.speechSynthesis.speak(ut);
  showToast("O'qish boshlandi... üîä");
});

/* Random */
function randomStory(){ const rand = stories[Math.floor(Math.random()*stories.length)]; openReader(rand.id); setDockActive('dockRand'); }

/* Search & filter */
searchEl.addEventListener('input', ()=> renderHome(document.querySelector('.chip.active').dataset.cat, searchEl.value));
chips.forEach(chip=> chip.addEventListener('click', ()=>{
  chips.forEach(c=> c.classList.remove('active'));
  chip.classList.add('active');
  renderHome(chip.dataset.cat, searchEl.value);
}));

/* Profile list */
function renderProfileList(type='saved'){
  profileFeedEl.innerHTML = '';
  const ids = type === 'saved' ? state.saved : state.liked;
  const items = stories.filter(s => ids.includes(s.id));
  if(items.length===0){ profileFeedEl.innerHTML = `<div style="text-align:center;padding:22px;color:var(--muted)">Hozircha bo'sh... üçÇ</div>`; return; }
  items.forEach(s=>{
    const el = document.createElement('div');
    el.className = 'story glass';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="font-weight:700;color:#fff">${s.title}</div><div style="font-size:13px;color:var(--muted)">üë§ ${s.author} ¬∑ #${s.cat}</div></div><div style="text-align:right;color:var(--muted)">üëÅÔ∏è ${s.views}<br/>‚ù§Ô∏è ${s.likes}</div></div>`;
    el.addEventListener('click', ()=> openReader(s.id));
    profileFeedEl.appendChild(el);
  });
}

/* Views & dock */
function switchView(id){
  document.querySelectorAll('.view').forEach(v=> v.classList.remove('active'));
  if(id === 'home') document.getElementById('home').classList.add('active');
  else if(id === 'profile') document.getElementById('profile').classList.add('active');
  // close reader if open
  readerOverlay.classList.remove('show');
  setDockActive(id === 'home' ? 'dockHome' : 'dockSaved');
}
function setDockActive(id){
  ['dockHome','dockRand','dockSaved','dockLiked'].forEach(i=> { const el=document.getElementById(i); if(el) el.classList.remove('active'); });
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
}

/* Theme toggle */
themeToggle.addEventListener('click', ()=>{
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', state.theme);
  localStorage.setItem('h21_theme', state.theme);
  updateThemeIcon();
});
function updateThemeIcon(){ themeToggle.innerText = state.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è'; }

/* Toast */
let toastTimer = null;
function showToast(msg=''){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toastEl.classList.remove('show'); }, 1800);
}

/* Init */
renderHome();
setDockActive('dockHome');
document.addEventListener('keydown', e=> {
  if(e.key === 'Escape') closeReader();
});
window.addEventListener('beforeunload', ()=> { window.speechSynthesis.cancel(); });
</script>
</body>
</html>
